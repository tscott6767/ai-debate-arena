<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Debate Arena</title>
  <style>
    body { background:#000; color:#0f9; font-family:'Courier New', monospace; margin:0; padding:20px; }
    h1 { text-align:center; margin-bottom:20px; }
    .panel { text-align:center; margin:15px 0; }
    textarea, input, select, button {
      background:#111; color:#0f9; border:1px solid #0f9; padding:8px;
      font-family:inherit; font-size:1em; margin:4px;
    }
    textarea { width:80%; max-width:900px; height:120px; resize:vertical; }
    button { cursor:pointer; font-weight:bold; padding:10px 20px; }
    button:hover { background:#0f9; color:#000; }
    #log {
      background:#001; border:1px solid #0f9; padding:15px; min-height:60vh; margin-top:20px;
      overflow-y:auto; white-space:pre-wrap; font-size:0.95em; line-height:1.4;
    }
    .label { color:#0bc; font-weight:bold; }
    .status { color:#ff0; font-size:0.9em; margin-left:10px; }
  </style>
</head>
<body>
  <h1>AI Debate Arena</h1>

  <div class="panel">
    <div class="label">Debate Topic (auto‑fetched continuation):</div><br>
    <textarea id="topic" placeholder="The latest transcript will appear here..."></textarea>
  </div>

  <div class="panel">
    <span class="label">Rounds:</span>
    <input id="rounds" type="number" min="1" max="50" value="12" style="width:70px;">
  </div>

  <div class="panel"><b>Side A</b><br>
    <span class="label">Provider:</span><select id="providerA" onchange="loadModels('A')"></select>
    <span class="label">Model:</span><select id="modelA"></select>
  </div>
  <div class="panel"><b>Side B</b><br>
    <span class="label">Provider:</span><select id="providerB" onchange="loadModels('B')"></select>
    <span class="label">Model:</span><select id="modelB"></select>
  </div>
  <div class="panel"><b>Judge</b><br>
    <span class="label">Provider:</span><select id="providerJudge" onchange="loadModels('Judge')"></select>
    <span class="label">Model:</span><select id="modelJudge"></select>
  </div>

  <div class="panel">
    <button id="start-btn">START DEBATE</button>
    <span id="status" class="status">Ready</span>
  </div>

  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    let ws = null;

    function appendLog(text) {
      logEl.insertAdjacentText("beforeend", text);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function loadProviders() {
      try {
        const res = await fetch('/api/models');
        const data = await res.json();
        const providers = Object.keys(data);
        ['A','B','Judge'].forEach(s => {
          const p = document.getElementById('provider'+s);
          const m = document.getElementById('model'+s);
          p.innerHTML = "";
          providers.forEach(x => p.appendChild(new Option(x,x)));
          if (providers.length) {
            p.value = providers[0];
            loadModels(s);
          }
        });
      } catch(e) {
        appendLog("Failed to load providers — server may be offline.\n");
      }
    }

    async function loadModels(s) {
      const prov = document.getElementById('provider'+s).value;
      const m = document.getElementById('model'+s);
      m.innerHTML = "<option>Loading...</option>";
      if (!prov) return;
      const res = await fetch(`/api/models?provider=${prov}`);
      const json = await res.json();
      m.innerHTML = "";
      (json.models || []).forEach(x => m.appendChild(new Option(x,x)));
      if (json.models?.length) m.value = json.models[0];
    }

    // ------------------------------------------------------------
    // Token‑based Option A: fetch continuation + register + start
    // ------------------------------------------------------------
    document.getElementById('start-btn').onclick = async () => {
      if (ws) ws.close();

      try {
        statusEl.textContent = "Fetching continuation...";
        appendLog("Fetching continuation topic...\n");

        const contRes = await fetch('/api/continuation?limit=1&round_no=13');
        const contData = await contRes.json();
        if (!contData.topic) {
          appendLog("No continuation topic.\n");
          statusEl.textContent = "No topic";
          return;
        }

        // Combine any manual prompt with continuation
        const box = document.getElementById('topic');
        const existing = box.value.trim();
        box.value = existing ? existing + "\n\n" + contData.topic : contData.topic;

        // Register topic (POST) to get short token
        const reg = await fetch('/api/register_topic', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ topic: box.value })
        });
        const regData = await reg.json();
        if (!regData.token) {
          appendLog("Topic registration failed.\n");
          return;
        }
        const token = regData.token;

        const defaults = { provider: "ollama", model: "llama3" };
        const val = id => document.getElementById(id).value ||
                          defaults[id.includes('provider') ? 'provider' : 'model'];

        const url = `ws://${location.host}/ws/debate`
          + `?token=${token}`
          + `&rounds=${document.getElementById('rounds').value||12}`
          + `&provider_a=${val('providerA')}&model_a=${val('modelA')}`
          + `&provider_b=${val('providerB')}&model_b=${val('modelB')}`
          + `&judge_provider=${val('providerJudge')}&judge_model=${val('modelJudge')}`;

        ws = new WebSocket(url);
        logEl.textContent = "Connecting...\n";
        statusEl.textContent = "Connecting...";

        ws.onopen = () => { statusEl.textContent="Debate STARTED"; appendLog("Connected — debate running...\n"); };
        ws.onmessage = e => appendLog(e.data);
        ws.onclose  = () => statusEl.textContent="Finished";
        ws.onerror  = () => statusEl.textContent="Error — check console";
      } catch (err) {
        appendLog("Start debate failed: " + err + "\n");
        statusEl.textContent = "Error";
      }
    };

    loadProviders();
  </script>
</body>
</html>
