<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Debate Arena</title>
  <style>
    :root {
      --glow: #0f9;
      --bg: #000;
      --dark: #001;
      --mid: #111;
    }

    body {
      background: var(--bg);
      color: var(--glow);
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
    }

    h1 {
      text-align: center;
      margin: 30px 0;
      text-shadow: 0 0 10px var(--glow);
    }

    .panel {
      text-align: center;
      margin: 20px auto;
      max-width: 960px;
    }

    textarea, input, select, button {
      background: var(--mid); /* ✅ fixed typo */
      color: var(--glow);
      border: 1px solid var(--glow);
      padding: 10px;
      font-family: inherit;
      font-size: 1em;
      margin: 6px;
      border-radius: 4px;
    }

    textarea {
      width: 90%;
      max-width: 900px;
      height: 140px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      font-weight: bold;
      padding: 12px 24px;
      transition: all 0.3s;
    }

    button:hover {
      background: var(--glow);
      color: #000;
      box-shadow: 0 0 15px var(--glow);
    }

    button:active {
      transform: scale(0.98);
    }

    button.danger {
      border-color: #f55;
      color: #f55;
    }

    button.danger:hover {
      background: #f55;
      color: #000;
    }

    #log {
      background: var(--dark);
      border: 2px solid var(--glow);
      padding: 20px;
      min-height: 65vh;
      margin: 30px auto;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 0.98em;
      line-height: 1.5;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,255,100,0.2);
    }

    .label { color: #0bc; font-weight: bold; }
    .status { color: #ff0; font-size: 1.1em; margin-left: 15px; font-weight: bold; }
    .controls { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
    .tag { background: #003; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; }
  </style>
</head>
<body>
  <h1>AI DEBATE ARENA</h1>

  <div class="panel">
    <div class="label">Debate Topic (auto-continued from last round)</div>
    <textarea id="topic" placeholder="Fetching latest continuation..."></textarea>
  </div>

  <div class="panel">
    <span class="label">Rounds:</span>
    <input id="rounds" type="number" min="1" max="50" value="12" style="width:80px;">
    <span id="status" class="status">Ready</span>
  </div>

  <div class="panel"><b>Side A (Pro)</b>
    <select id="providerA" onchange="loadModels('A')"></select>
    <select id="modelA"></select>
  </div>
  <div class="panel"><b>Side B (Con)</b>
    <select id="providerB" onchange="loadModels('B')"></select>
    <select id="modelB"></select>
  </div>
  <div class="panel"><b>Judge</b>
    <select id="providerJudge" onchange="loadModels('Judge')"></select>
    <select id="modelJudge"></select>
  </div>

  <div class="controls">
    <button id="start-btn">START DEBATE</button>
    <button id="stop-btn" class="danger" style="display:none;">STOP DEBATE</button>
    <button id="clear-btn">Clear Log</button>
    <button id="export-btn">Export Transcript</button>
  </div>

  <!-- ✅ Replaced literal '\n' with an actual line break -->
  <div id="log">AI Debate Arena initialized. Click "START DEBATE" to begin.<br></div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    let ws = null;

    function appendLog(text) {
      logEl.insertAdjacentText("beforeend", text);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(txt, color = "#ff0") {
      statusEl.textContent = txt;
      statusEl.style.color = color;
    }

    async function loadProviders() {
      try {
        const res = await fetch('/api/models');
        const data = await res.json();
        const providers = Object.keys(data.providers || data);
        ['A', 'B', 'Judge'].forEach(side => {
          const sel = document.getElementById('provider' + side);
          sel.innerHTML = "<option>Loading...</option>";
          providers.forEach(p => sel.appendChild(new Option(p.toUpperCase(), p)));
          sel.value = "ollama";
          loadModels(side);
        });
      } catch (e) {
        appendLog("Failed to load providers — is backend running?\n");
        setStatus("Backend offline", "#f55");
      }
    }

    async function loadModels(side) {
      const prov = document.getElementById('provider' + side).value;
      const modelSel = document.getElementById('model' + side);
      modelSel.innerHTML = "<option>Loading models...</option>";
      try {
        const res = await fetch(`/api/models?provider=${prov}`);
        const json = await res.json();
        modelSel.innerHTML = "";
        (json.models || []).forEach(m => modelSel.appendChild(new Option(m, m)));
        if (json.models?.length) modelSel.value = json.models[0];
      } catch (e) {
        modelSel.innerHTML = "<option>Error loading</option>";
      }
    }

    document.getElementById('start-btn').onclick = async () => {
      if (ws) ws.close();
      stopBtn.style.display = "inline-block";
      startBtn.disabled = true;
      logEl.textContent = "Fetching continuation topic...\n";
      setStatus("Preparing debate...", "#0cf");

      try {
        // ✅ dynamic round number instead of hard-coded 13
        const roundsVal = document.getElementById('rounds').value || 12;
        const contRes = await fetch(`/api/continuation?limit=3&round_no=${roundsVal}`);
        const cont = await contRes.json();
        if (!cont.topic) throw "No continuation available";

        const topicBox = document.getElementById('topic');
        const manual = topicBox.value.trim();
        topicBox.value = manual ? manual + "\n\n" + cont.topic : cont.topic;

        const reg = await fetch('/api/register_topic', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ topic: topicBox.value })
        });
        const { token } = await reg.json();

        const protocol = location.protocol === "https:" ? "wss://" : "ws://";
        const url = new URL(protocol + location.host + "/ws/debate");
        url.searchParams.append("token", token);
        url.searchParams.append("rounds", roundsVal);
        ["A", "B", "Judge"].forEach(s => {
  const lower = s.toLowerCase();
  url.searchParams.append(`provider_${lower}`, document.getElementById('provider' + s).value);
  url.searchParams.append(`model_${lower}`, document.getElementById('model' + s).value);
});

        ws = new WebSocket(url);

        ws.onopen = () => {
          setStatus("DEBATE IN PROGRESS", "#0f9");
          appendLog("\nCONNECTED — Debate started!\n\n");
        };
        ws.onmessage = e => appendLog(e.data);
        ws.onclose = () => {
          setStatus("Debate finished", "#0f9");
          stopBtn.style.display = "none";
          startBtn.disabled = false;
        };
        ws.onerror = () => setStatus("Connection error", "#f55");

      } catch (err) {
        appendLog("Failed to start: " + err + "\n");
        setStatus("Error", "#f55");
        startBtn.disabled = false;
        stopBtn.style.display = "none";
      }
    };

    stopBtn.onclick = () => { if (ws) ws.close(); };
    document.getElementById('clear-btn').onclick = () => logEl.textContent = "";
    document.getElementById('export-btn').onclick = () => {
      const blob = new Blob([logEl.textContent], {type: "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `debate_${new Date().toISOString().slice(0,19)}.txt`;
      a.click();
    };

    // Auto-load providers on start
    loadProviders();
  </script>
</body>
</html>
